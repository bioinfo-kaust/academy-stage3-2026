<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab 4: Quality Control Hands-on - Bioinformatics 2026</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <nav>
        <div class="nav-container">
            <a href="../index.html" class="logo">Bioinformatics Specialization Program - KAUST Academy</a>
            <button class="nav-toggle" onclick="toggleNav()">&#9776;</button>
            <ul id="nav-menu">
                <li><a href="../index.html">Home</a></li>
                <li><a href="schedule.html">Schedule</a></li>
                <li><a href="labs.html" class="active">Labs</a></li>
                <li><a href="projects.html">Projects</a></li>
                <li><a href="setup.html">Setup</a></li>
            </ul>
        </div>
    </nav>

    <main>
        <div class="breadcrumbs">
            <a href="../index.html">Home</a> / <a href="labs.html">Labs</a> / Lab 4
        </div>

        <div class="lab-header">
            <h1>Lab 4: Quality Control Hands-on</h1>
            <p class="lab-meta">Day 2 | Duration: 45 minutes</p>
        </div>

        <section>
            <h2>Objectives</h2>
            <ul>
                <li>Apply quality trimming to remove low-quality bases</li>
                <li>Remove adapter sequences from reads</li>
                <li>Compare pre- and post-QC metrics to verify improvements</li>
                <li>Understand when and how much to trim</li>
            </ul>
        </section>

        <section>
            <h2>Background</h2>
            <p>After identifying quality issues in Lab 3, we now apply preprocessing steps to improve data quality. The goal is to remove low-quality bases and adapter contamination while retaining as much useful data as possible.</p>
            <p>We will use <strong>fastp</strong>, a modern all-in-one tool that performs adapter detection, quality filtering, and generates comprehensive reports in a single step. It's fast, accurate, and provides both HTML and JSON reports for easy analysis.</p>
        </section>

        <section>
            <h2>Instructions</h2>

            <div class="step" data-step="1">
                <h3>Set up your environment</h3>
                <pre><code># Navigate to project directory
cd ~/bioinformatics_course

# Activate conda environment
conda activate bioinformatics_course

# Create output directory
mkdir -p trimmed_data</code></pre>
            </div>

            <div class="step" data-step="2">
                <h3>Run fastp for trimming</h3>
                <p>fastp performs adapter trimming, quality filtering, and generates comprehensive reports in one step.</p>
                <pre><code># Run fastp on paired-end data
fastp \
    -i raw_data/sample_1.fastq.gz \
    -I raw_data/sample_2.fastq.gz \
    -o trimmed_data/sample_1.trimmed.fastq.gz \
    -O trimmed_data/sample_2.trimmed.fastq.gz \
    --qualified_quality_phred 20 \
    --length_required 36 \
    --detect_adapter_for_pe \
    --correction \
    --cut_front \
    --cut_tail \
    --cut_window_size 4 \
    --cut_mean_quality 20 \
    --html trimmed_data/sample_fastp_report.html \
    --json trimmed_data/sample_fastp_report.json \
    --thread 4

# Parameters explained:
# -i/-I: Input paired-end files (R1/R2)
# -o/-O: Output paired-end files (R1/R2)
# --qualified_quality_phred 20: Quality threshold (Q20)
# --length_required 36: Minimum read length after trimming
# --detect_adapter_for_pe: Auto-detect adapters for paired-end
# --correction: Enable base correction in overlapping regions
# --cut_front/--cut_tail: Sliding window trimming from both ends
# --cut_window_size 4: Window size for quality trimming
# --cut_mean_quality 20: Mean quality threshold for sliding window</code></pre>
                <div class="info-box note">
                    <strong>Note</strong>
                    fastp automatically detects and removes common Illumina adapter sequences. For other platforms or custom adapters, use <code>--adapter_sequence</code> and <code>--adapter_sequence_r2</code>.
                </div>
            </div>

            <div class="step" data-step="3">
                <h3>Process all samples with a loop</h3>
                <p>Use a loop to process multiple samples efficiently.</p>
                <pre><code># Process all samples
for sample in SRR1039508 SRR1039509 SRR1039512 SRR1039513; do
    echo "Processing ${sample}..."

    fastp \
        -i raw_data/${sample}_1.fastq.gz \
        -I raw_data/${sample}_2.fastq.gz \
        -o trimmed_data/${sample}_1.trimmed.fastq.gz \
        -O trimmed_data/${sample}_2.trimmed.fastq.gz \
        --qualified_quality_phred 20 \
        --length_required 36 \
        --detect_adapter_for_pe \
        --correction \
        --cut_front \
        --cut_tail \
        --html trimmed_data/${sample}_fastp.html \
        --json trimmed_data/${sample}_fastp.json \
        --thread 4

    echo "Completed ${sample}"
done</code></pre>
            </div>

            <div class="step" data-step="4">
                <h3>Compare pre- and post-trimming quality</h3>
                <p>Run FastQC on trimmed data and compare with original reports.</p>
                <pre><code># Run FastQC on trimmed files
mkdir -p qc_reports/fastqc_trimmed
fastqc trimmed_data/*.trimmed.fastq.gz -o qc_reports/fastqc_trimmed -t 4

# Compare file sizes (trimmed should be smaller)
echo "Raw data sizes:"
ls -lh raw_data/*.fastq.gz

echo "Trimmed data sizes:"
ls -lh trimmed_data/*.trimmed.fastq.gz

# Compare read counts using seqkit
echo "Read counts comparison:"
seqkit stats raw_data/*.fastq.gz trimmed_data/*.trimmed.fastq.gz -T | column -t</code></pre>
            </div>

            <div class="step" data-step="5">
                <h3>Analyze trimming statistics</h3>
                <p>Review the fastp reports to understand what was removed.</p>
                <pre><code># Open the HTML report in browser (recommended)
# The HTML report provides interactive charts and detailed statistics

# Or parse the JSON report programmatically
python3 << 'EOF'
import json
import glob

print("=" * 70)
print(f"{'Sample':<15} {'Reads Before':>15} {'Reads After':>15} {'Retained':>10} {'Q30 Before':>10} {'Q30 After':>10}")
print("=" * 70)

for json_file in sorted(glob.glob('trimmed_data/*_fastp.json')):
    with open(json_file) as f:
        data = json.load(f)

    sample = json_file.split('/')[-1].replace('_fastp.json', '')
    before = data['summary']['before_filtering']
    after = data['summary']['after_filtering']

    retained = (after['total_reads'] / before['total_reads']) * 100

    print(f"{sample:<15} {before['total_reads']:>15,} {after['total_reads']:>15,} "
          f"{retained:>9.1f}% {before['q30_rate']*100:>9.1f}% {after['q30_rate']*100:>9.1f}%")

print("=" * 70)
EOF

# Key metrics to check in the report:
# - Total reads processed vs retained
# - Adapter trimming rate
# - Duplication rate
# - Quality score distribution improvement</code></pre>
            </div>

            <div class="step" data-step="6">
                <h3>Best practices for trimming</h3>
                <div class="info-box tip">
                    <strong>Trimming Guidelines</strong>
                    <ul>
                        <li>Use Q20 as a reasonable quality threshold for most applications</li>
                        <li>Set minimum length based on your downstream analysis (36-50 bp typical)</li>
                        <li>Don't over-trim: losing too many reads can hurt analysis</li>
                        <li>For RNA-seq, adapter trimming is essential; quality trimming is often less critical</li>
                        <li>Always verify improvements with post-trimming QC</li>
                    </ul>
                </div>
            </div>
        </section>

        <section>
            <h2>Summary</h2>
            <p>In this lab, you learned to:</p>
            <ul>
                <li>Apply quality and adapter trimming using multiple tools</li>
                <li>Choose appropriate trimming parameters</li>
                <li>Compare pre- and post-trimming quality metrics</li>
                <li>Interpret trimming statistics</li>
            </ul>
        </section>

        <section>
            <h2>Next Steps</h2>
            <p>In <a href="lab5.html">Lab 5</a>, we will align our cleaned reads to a reference genome using STAR.</p>
        </section>
    </main>

    <footer>
        <p>Bioinformatics Specialization Program 2026 - KAUST Academy</p>
    </footer>

    <script>
        function toggleNav() {
            document.getElementById('nav-menu').classList.toggle('show');
        }
    </script>
</body>
</html>
