<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab 7: Differential Expression Analysis - Bioinformatics 2026</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <nav>
        <div class="nav-container">
            <a href="../index.html" class="logo">Bioinformatics 2026</a>
            <button class="nav-toggle" onclick="toggleNav()">&#9776;</button>
            <ul id="nav-menu">
                <li><a href="../index.html">Home</a></li>
                <li><a href="schedule.html">Schedule</a></li>
                <li><a href="labs.html" class="active">Labs</a></li>
                <li><a href="setup.html">Setup</a></li>
            </ul>
        </div>
    </nav>

    <main>
        <div class="breadcrumbs">
            <a href="../index.html">Home</a> / <a href="labs.html">Labs</a> / Lab 7
        </div>

        <div class="lab-header">
            <h1>Lab 7: Differential Expression Analysis</h1>
            <p class="lab-meta">Day 3 | Duration: 60 minutes</p>
        </div>

        <section>
            <h2>Objectives</h2>
            <ul>
                <li>Set up DESeq2 analysis in R</li>
                <li>Understand normalization and dispersion estimation</li>
                <li>Run differential expression analysis</li>
                <li>Interpret DE results and visualize with PCA and MA plots</li>
            </ul>
        </section>

        <section>
            <h2>Background</h2>
            <p>DESeq2 is one of the most widely used tools for differential expression analysis. It uses a negative binomial model to account for the count nature of RNA-seq data and estimates dispersion to model biological variability. Key steps include:</p>
            <ol>
                <li>Normalization (accounting for library size differences)</li>
                <li>Dispersion estimation (modeling gene-wise variability)</li>
                <li>Statistical testing (negative binomial GLM)</li>
                <li>Multiple testing correction (Benjamini-Hochberg)</li>
            </ol>
        </section>

        <section>
            <h2>Instructions</h2>

            <div class="step" data-step="1">
                <h3>Start R and load libraries</h3>
                <pre><code># Start R
R

# Load required libraries
library(DESeq2)
library(ggplot2)
library(pheatmap)

# Set working directory
setwd("~/bioinformatics_course")</code></pre>
            </div>

            <div class="step" data-step="2">
                <h3>Load count data and sample information</h3>
                <pre><code># Read count matrix
counts <- read.table("counts/expression_matrix.tsv",
                     header = TRUE,
                     row.names = 1,
                     sep = "\t")

# View the data
head(counts)
dim(counts)

# Create sample metadata (colData)
# Adjust this based on your actual sample names and conditions
sample_info <- data.frame(
    row.names = colnames(counts),
    condition = factor(c("control", "control", "control",
                        "treatment", "treatment", "treatment")),
    replicate = factor(c(1, 2, 3, 1, 2, 3))
)

# Verify sample order matches
all(rownames(sample_info) == colnames(counts))</code></pre>
            </div>

            <div class="step" data-step="3">
                <h3>Create DESeq2 dataset</h3>
                <pre><code># Create DESeqDataSet object
dds <- DESeqDataSetFromMatrix(
    countData = counts,
    colData = sample_info,
    design = ~ condition  # Compare conditions
)

# View the object
dds

# Pre-filter low count genes (recommended)
# Keep genes with at least 10 total counts
keep <- rowSums(counts(dds)) >= 10
dds <- dds[keep, ]

cat("Genes after filtering:", nrow(dds), "\n")</code></pre>
            </div>

            <div class="step" data-step="4">
                <h3>Run DESeq2 analysis</h3>
                <pre><code># Run the full DESeq2 pipeline
# This performs: estimation of size factors, dispersion, and fitting
dds <- DESeq(dds)

# View the results names (available comparisons)
resultsNames(dds)</code></pre>
            </div>

            <div class="step" data-step="5">
                <h3>Extract and examine results</h3>
                <pre><code># Get results for the comparison
# Default: last level vs first level (treatment vs control)
res <- results(dds, alpha = 0.05)

# View summary
summary(res)

# View results table
head(res[order(res$padj), ])

# Columns explained:
# baseMean: Average normalized count across all samples
# log2FoldChange: log2(treatment/control)
# lfcSE: Standard error of log2FC
# stat: Wald statistic
# pvalue: Raw p-value
# padj: Adjusted p-value (BH correction)</code></pre>
            </div>

            <div class="step" data-step="6">
                <h3>Apply log fold change shrinkage</h3>
                <p>Shrinkage improves log2FC estimates for genes with low counts or high dispersion.</p>
                <pre><code># Apply shrinkage (recommended for visualization)
res_shrunk <- lfcShrink(dds,
                        coef = "condition_treatment_vs_control",
                        type = "apeglm")

# Compare shrunken vs unshrunken
par(mfrow = c(1, 2))
plotMA(res, main = "Unshrunken", ylim = c(-5, 5))
plotMA(res_shrunk, main = "Shrunken", ylim = c(-5, 5))</code></pre>
            </div>

            <div class="step" data-step="7">
                <h3>Generate PCA plot</h3>
                <p>PCA helps visualize sample relationships and identify potential batch effects.</p>
                <pre><code># Variance stabilizing transformation for visualization
vsd <- vst(dds, blind = FALSE)

# PCA plot
pcaData <- plotPCA(vsd, intgroup = "condition", returnData = TRUE)
percentVar <- round(100 * attr(pcaData, "percentVar"))

ggplot(pcaData, aes(PC1, PC2, color = condition)) +
    geom_point(size = 4) +
    xlab(paste0("PC1: ", percentVar[1], "% variance")) +
    ylab(paste0("PC2: ", percentVar[2], "% variance")) +
    theme_bw() +
    ggtitle("PCA of RNA-seq samples")

ggsave("results/pca_plot.png", width = 8, height = 6)</code></pre>
            </div>

            <div class="step" data-step="8">
                <h3>Identify significant genes</h3>
                <pre><code># Filter for significant genes
sig_genes <- subset(res, padj < 0.05 & abs(log2FoldChange) > 1)

# Summary of significant genes
cat("Significant genes (padj < 0.05, |log2FC| > 1):", nrow(sig_genes), "\n")
cat("Upregulated:", sum(sig_genes$log2FoldChange > 0), "\n")
cat("Downregulated:", sum(sig_genes$log2FoldChange < 0), "\n")

# View top upregulated genes
head(sig_genes[order(-sig_genes$log2FoldChange), ])

# View top downregulated genes
head(sig_genes[order(sig_genes$log2FoldChange), ])</code></pre>
            </div>

            <div class="step" data-step="9">
                <h3>Save results</h3>
                <pre><code># Create results directory
dir.create("results", showWarnings = FALSE)

# Save full results
write.csv(as.data.frame(res[order(res$padj), ]),
          "results/deseq2_all_results.csv")

# Save significant genes only
write.csv(as.data.frame(sig_genes[order(sig_genes$padj), ]),
          "results/deseq2_significant_genes.csv")

# Save normalized counts
normalized_counts <- counts(dds, normalized = TRUE)
write.csv(normalized_counts, "results/normalized_counts.csv")

cat("Results saved to results/ directory\n")</code></pre>
            </div>
        </section>

        <section>
            <h2>Understanding the Results</h2>
            <div class="info-box note">
                <strong>Interpreting log2FoldChange</strong>
                <ul>
                    <li>log2FC = 1 means 2x higher expression in treatment</li>
                    <li>log2FC = -1 means 2x lower expression in treatment</li>
                    <li>log2FC = 2 means 4x higher expression</li>
                    <li>log2FC = 0 means no change</li>
                </ul>
            </div>

            <div class="info-box tip">
                <strong>Significance Thresholds</strong>
                <p>Common cutoffs for differential expression:</p>
                <ul>
                    <li>Adjusted p-value (padj) < 0.05</li>
                    <li>|log2FoldChange| > 1 (2-fold change)</li>
                </ul>
                <p>These thresholds may be adjusted based on your research question.</p>
            </div>
        </section>

        <section>
            <h2>Summary</h2>
            <p>In this lab, you learned to:</p>
            <ul>
                <li>Create a DESeq2 dataset from count matrices</li>
                <li>Run the DESeq2 differential expression pipeline</li>
                <li>Interpret results including log2FC, p-values, and adjusted p-values</li>
                <li>Generate PCA and MA plots for quality assessment</li>
                <li>Identify and export significant differentially expressed genes</li>
            </ul>
        </section>

        <section>
            <h2>Next Steps</h2>
            <p>In <a href="lab8.html">Lab 8</a>, we will create publication-quality visualizations including volcano plots and heatmaps.</p>
        </section>
    </main>

    <footer>
        <p>Bioinformatics Specialization Program 2026</p>
    </footer>

    <script>
        function toggleNav() {
            document.getElementById('nav-menu').classList.toggle('show');
        }
    </script>
</body>
</html>
