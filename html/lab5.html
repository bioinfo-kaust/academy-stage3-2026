<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab 5: Differential Expression Analysis - Bioinformatics 2026</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <nav>
        <div class="nav-container">
            <a href="../index.html" class="logo">Bioinformatics Specialization Program - KAUST Academy</a>
            <button class="nav-toggle" onclick="toggleNav()">&#9776;</button>
            <ul id="nav-menu">
                <li><a href="../index.html">Home</a></li>
                <li><a href="schedule.html">Schedule</a></li>
                <li><a href="labs.html" class="active">Labs</a></li>
                <li><a href="projects.html">Projects</a></li>
                <li><a href="setup.html">Setup</a></li>
            </ul>
        </div>
    </nav>

    <main>
        <h1>Lab 5: Differential Expression Analysis</h1>

        <div class="info-box note">
            <strong>Learning Objectives</strong>
            <ul>
                <li>Understand the DESeq2 statistical framework</li>
                <li>Run differential expression analysis comparing KO vs WT</li>
                <li>Interpret DE results (log2 fold change, p-values, adjusted p-values)</li>
                <li>Filter and export significant differentially expressed genes</li>
            </ul>
        </div>

        <section>
            <h2>DESeq2 Overview</h2>
            <div class="card">
                <h3>Why DESeq2?</h3>
                <p>DESeq2 is the gold-standard tool for differential expression analysis because it:</p>
                <ul>
                    <li>Models count data with negative binomial distribution</li>
                    <li>Performs size factor normalization to account for library size differences</li>
                    <li>Uses shrinkage estimators for dispersion and fold changes</li>
                    <li>Properly controls false discovery rate (FDR) with Benjamini-Hochberg correction</li>
                </ul>
            </div>

            <div class="card">
                <h3>Key Concepts</h3>
                <table class="schedule-table">
                    <tr><th>Term</th><th>Description</th></tr>
                    <tr><td>log2 Fold Change</td><td>log2(KO/WT) - positive means upregulated in KO</td></tr>
                    <tr><td>p-value</td><td>Probability of observing the difference by chance</td></tr>
                    <tr><td>padj (adjusted p-value)</td><td>p-value corrected for multiple testing (FDR)</td></tr>
                    <tr><td>baseMean</td><td>Average normalized count across all samples</td></tr>
                </table>
            </div>

            <div class="card">
                <h3>Output - Lab 4b: <a href="https://raw.githubusercontent.com/bioinfo-kaust/academy-stage3-2026/refs/heads/main/output/counts.zip">Download counts.zip</a></h3>
                <p>In case you have not obtained the results from Lab 4 (the gene count table), you can download <a href="https://raw.githubusercontent.com/bioinfo-kaust/academy-stage3-2026/refs/heads/main/output/counts.zip">lab4-output</a> folder and unzip it. It contains all files that are required for this lab and the remaining ones.</p>
            </div>
        </section>

        <section>
            <h2>Part 1: Setup & Start Jupyter Notebook</h2>

            <div class="step" data-step="1">
                <strong>Install required pacakges and setup the kernel</strong>
                <pre><code>conda activate genomics

mamba install -c conda-forge -c bioconda jupyter jupyterlab r-irkernel -y

R -e "IRkernel::installspec(name='genomics', displayname='R (DESeq2)')"

# Verify installation
jupyter --version
    </code></pre>
            </div>
            <div class="step" data-step="2">
                <strong>Start jupyter notebook</strong>
                <pre><code>cd ~/genomics

# Launch Jupyter Notebook
jupyter notebook</code></pre>
            </div>
            <div class="step" data-step="3">
                <ul>
                    <strong>Create a new notebook:</strong> 
                    <li>In Jupyter (or JupyterLab), choose <em>File → New → Notebook</em>, then select the R kernel.</li>
                    <li>Set working directory: In the first cell, run <code>setwd("~/genomics")</code> so paths below work.</li>
                    <li>Copy each code block below into a separate cell and run them in order (Shift+Enter). </li>
                </ul>
            </div>
            </div>
            <section>
                <h2>Part 2: Run DESeq2 Analysis</h2>
            <div class="step" data-step="1">
                <h3>Load libraries</h3>
                <pre><code>library(DESeq2)
library(tximport)</code></pre>
            </div>

            <div class="step" data-step="2">
                <h3>Load data</h3>
                <pre><code>txi <- readRDS("~/genomics/counts/tximport.rds")
sample_info <- read.table("~/genomics/counts/sample_info.tsv", header = TRUE, sep = "\t")

# Set factor levels (WT as reference)
sample_info$condition <- factor(sample_info$condition, levels = c("WT", "KO"))

cat(paste0("Samples: ", nrow(sample_info), "\n"))
cat(paste0("Genes: ", nrow(txi$counts), "\n"))
cat(paste0("Conditions: ", paste(levels(sample_info$condition), collapse = " vs "), "\n"))</code></pre>
            </div>

            <div class="step" data-step="3">
                <h3>Create DESeq2 dataset and pre-filter</h3>
                <pre><code>dds <- DESeqDataSetFromTximport(txi, colData = sample_info, design = ~ condition)

# Pre-filtering: Remove genes with very low counts
keep <- rowSums(counts(dds) >= 10) >= 3
dds <- dds[keep, ]
cat(paste0("Genes after filtering (>=10 counts in >=3 samples): ", nrow(dds), "\n"))</code></pre>
            </div>

            <div class="step" data-step="4">
                <h3>Run DESeq2 and get results</h3>
                <pre><code>dds <- DESeq(dds)
                res <- results(dds, contrast = c("condition", "KO", "WT"))
res <- res[order(res$padj), ]

summary(res)

# Significant: padj < 0.05 and |log2FC| > 1
sig_genes <- subset(res, padj < 0.05 & abs(log2FoldChange) > 1)
sig_genes <- sig_genes[order(sig_genes$padj), ]

cat(paste0("Total significant genes: ", nrow(sig_genes), "\n"))
cat(paste0("Upregulated in KO: ", sum(sig_genes$log2FoldChange > 0, na.rm = TRUE), "\n"))
cat(paste0("Downregulated in KO: ", sum(sig_genes$log2FoldChange < 0, na.rm = TRUE), "\n"))</code></pre>
            </div>

            <div class="step" data-step="5">
                <h3>Save results</h3>
                <pre><code>dir.create("~/genomics/results/tables", showWarnings = FALSE, recursive = TRUE)

# All results
all_res <- as.data.frame(res)
all_res$gene_id <- rownames(all_res)
all_res <- all_res[, c("gene_id", "baseMean", "log2FoldChange", "lfcSE", "stat", "pvalue", "padj")]
write.csv(all_res, "~/genomics/results/tables/deseq2_all_results.csv", row.names = FALSE)

# Significant genes only
sig_res <- as.data.frame(sig_genes)
sig_res$gene_id <- rownames(sig_res)
sig_res <- sig_res[, c("gene_id", "baseMean", "log2FoldChange", "lfcSE", "stat", "pvalue", "padj")]
write.csv(sig_res, "~/genomics/results/tables/deseq2_significant.csv", row.names = FALSE)

# Normalized counts
norm_counts <- as.data.frame(counts(dds, normalized = TRUE))
norm_counts$gene_id <- rownames(norm_counts)
write.csv(norm_counts, "~/genomics/results/tables/normalized_counts.csv", row.names = FALSE)

# Save DESeq2 object for later use
saveRDS(dds, "~/genomics/results/deseq2_object.rds")</code></pre>
            </div>
            <div class="info-box tip">
                <h3>Optional: Alternative Approach - Run from Command Line</h3>
                <p>To run as a script instead of a notebook, save all blocks above into <code>deseq2_analysis.R</code>, then:</p>
                <pre><code>cd ~/genomics
Rscript scripts/deseq2_analysis.R
ls -lh results/tables/</code></pre>
            </div>
        </section>

        <section>
            <h2>Part 3: Understanding the Results</h2>
            <strong>Open the results/tables/deseq2_significant.csv file in MS Excel and check the output</strong>
            <div class="card">
                <h3>Interpreting the Output</h3>
                <ul>
                    <li><strong>Positive log2FC:</strong> Gene is upregulated in KO (higher expression when TDP-43 is knocked out)</li>
                    <li><strong>Negative log2FC:</strong> Gene is downregulated in KO (lower expression when TDP-43 is knocked out)</li>
                    <li><strong>padj < 0.05:</strong> Statistically significant after multiple testing correction</li>
                    <li><strong>|log2FC| > 1:</strong> At least 2-fold change in expression</li>
                </ul>
            </div>

            <div class="info-box tip">
                <strong>Biological Interpretation</strong>
                <p>Since TDP-43 is an RNA-binding protein involved in RNA processing:</p>
                <ul>
                    <li>Upregulated genes in KO may be normally suppressed by TDP-43</li>
                    <li>Downregulated genes in KO may depend on TDP-43 for proper expression/stability</li>
                </ul>
            </div>
        </section>

        <section>
            <h2>Exercises</h2>
            <div class="card">
                <h3>Exercise 1: Results Exploration</h3>
                <ol>
                    <li>How many genes pass the significance threshold of padj < 0.01?</li>
                    <li>What are the genes with the most positive and most negative fold change?</li>
                    <li>Look up one of the top genes in a gene database (e.g., GeneCards, NCBI Gene)</li>
                </ol>
            </div>
        </section>

        <section>
            <h2>Summary</h2>
            <p>In this lab, you have:</p>
            <ul>
                <li>Run DESeq2 differential expression analysis</li>
                <li>Identified genes differentially expressed between KO and WT</li>
                <li>Learned to interpret fold changes and adjusted p-values</li>
            </ul>
            <p><strong>Next:</strong> <a href="lab6.html">Lab 6 - Visualization & QC Plots</a></p>
        </section>
    </main>

    <footer>
        <p>Bioinformatics Specialization Program 2026 - KAUST Academy</p>
    </footer>

    <script>
        function toggleNav() {
            document.getElementById('nav-menu').classList.toggle('show');
        }

        // Add copy buttons to all code blocks
        document.addEventListener('DOMContentLoaded', function() {
            const codeBlocks = document.querySelectorAll('pre');
            codeBlocks.forEach(function(pre) {
                const container = document.createElement('div');
                container.className = 'code-container';
                pre.parentNode.insertBefore(container, pre);
                container.appendChild(pre);

                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-btn';
                copyBtn.textContent = 'Copy';
                copyBtn.addEventListener('click', function() {
                    const code = pre.querySelector('code');
                    const text = code ? code.textContent : pre.textContent;
                    navigator.clipboard.writeText(text).then(function() {
                        copyBtn.textContent = 'Copied!';
                        copyBtn.classList.add('copied');
                        setTimeout(function() {
                            copyBtn.textContent = 'Copy';
                            copyBtn.classList.remove('copied');
                        }, 2000);
                    });
                });
                container.appendChild(copyBtn);
            });
        });
    </script>
</body>
</html>
